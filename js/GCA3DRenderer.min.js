import*as THREE from"./three.module.js";import{MARenderer,MARenderMode,MARenderShape}from"./MARender.js";class GCA3DRenderer{constructor(wind,cont,pick){this.type="GCA3DRenderer",this._config=void 0,Object.defineProperty(this,"version",{value:"2.2.1",writable:!1}),this._pickerFn=pick,this._curPath=0,this._curPathIdx=0,this._roiIdx=[0,0],this._ren=new MARenderer(wind,cont),this.nameSep="-",this.referenceNamePrefix="ref",this.anatomyNamePrefix="ana",this.discNamePrefix="disc",this.pathNamePrefix="path",this.trackNamePrefix="track",this.landmarkNamePrefix="lm",this.landmarkNameLblPrefix="ll",this.markerNamePrefix="mm",this.markerNameLblPrefix="ml"}init(cfg){this._isString(cfg)&&(cfg=this._loadJson(cfg)),this._isArray(cfg)&&(cfg=cfg[0]),this._setConfig(cfg),this._loadPaths(),this._ren.init(),Boolean(this._config.display_props.pick_precision)||(this._config.display_props.pick_precision=1),this._ren.raycaster.linePrecision=this._config.display_props.pick_precision,this._ren.win.addEventListener("pointerdown",this._ren._pick.bind(this._ren),!1),this._ren.win.addEventListener("pointerup",this._ren._pick.bind(this._ren),!1),this._ren.addEventListener("pick",this._picker.bind(this),!1)}getConfig(){return this._config}addModels(){if(Boolean(this._config.reference_surfaces)&&this._isArray(this._config.reference_surfaces)&&this._config.reference_surfaces.length>0)for(let i=0,l=this._config.reference_surfaces.length;i<l;++i){let ref=this._config.reference_surfaces[i],dsp=ref.display_props;this._ren.addModel({name:this.getReferenceName()+String(i),path:this._config.model_dir+ref.filepath+"/"+ref.filename,color:dsp.color,opacity:dsp.opacity,transparent:!0})}if(Boolean(this._config.anatomy_surfaces)&&this._isArray(this._config.anatomy_surfaces)&&this._config.anatomy_surfaces.length>0)for(let i=0,l=this._config.anatomy_surfaces.length;i<l;++i){let anat=this._config.anatomy_surfaces[i],dsp=anat.display_props;this._ren.addModel({name:this.getAnatomyName(anat.id),path:this._config.model_dir+anat.filepath+"/"+anat.filename,color:dsp.color,opacity:dsp.opacity,transparent:!0}),this._isDefined(anat.map_filename)&&(anat.mapping=this._loadJson(this._config.model_dir+anat.filepath+"/"+anat.map_filename))}let dsc=this._config.disc,dsp=dsc.display_props;this._ren.addModel({name:this.getDiscName(dsc.id),mode:MARenderMode.SHAPE,style:MARenderShape.DISC,color:dsp.color,size:dsp.radius,extrude:dsp.thickness});for(let i=0,l=this._config.paths.length;i<l;++i){let pth=this._config.paths[i],dsp=pth.display_props;this._ren.addModel({name:this.getPathName(pth.id),mode:MARenderMode.PATH,color:dsp.color,linewidth:dsp.line_width,vertices:pth.points,tangents:pth.tangents})}let lof=this._config.display_props.label_offset;lof=new THREE.Vector3(lof[0],lof[1],lof[2]);for(let i=0;i<this._config.landmarks.length;++i){let lmk=this._config.landmarks[i];for(let j=0;j<lmk.paths.length;++j){let lpi=this._config.pathIdToIdx[lmk.paths[j]],pas=this._config.paths[lpi].points[lmk.position[j]],pos=new THREE.Vector3(pas[0],pas[1],pas[2]);this._ren.addModel({name:this.getLandmarkName(lmk.id),mode:MARenderMode.MARKER,position:pos}),this._ren.addModel({name:this.getLandmarkLblName(lmk.id),mode:MARenderMode.LABEL,text:lmk.anatomy[0].abbreviated_name,position:pos.add(lof)})}}}setView(){let dsp=this._config.display_props,v=dsp.model_views[dsp.viewTypeToIdx[dsp.default_view]],c=new THREE.Vector3(v.centre[0],v.centre[1],v.centre[2]),p=new THREE.Vector3(v.cam_pos[0],v.cam_pos[1],v.cam_pos[2]),u=new THREE.Vector3(v.up[0],v.up[1],v.up[2]);this._ren.setCamera(c,v.near,v.far,p),this._ren.setHome(p,u),this._ren.goHome()}addMarker(name,pos,col,txt){if(pos=new THREE.Vector3(pos[0],pos[1],pos[2]),this._ren.addModel({name:this.getMarkerName(name),mode:MARenderMode.MARKER,color:col,position:pos}),txt){let dp=this._config.display_props,lof=new THREE.Vector3(dp.label_offset[0],dp.label_offset[1],dp.label_offset[2]);this._ren.addModel({name:this.getMarkerLblName(name),mode:MARenderMode.LABEL,text:txt,position:pos.add(lof)})}}removeMarker(name){this._ren.removeModel(this.getMarkerName(name)),this._ren.removeModel(this.getMarkerLblName(name))}mapIntervalToMidline(lmk0,lmk1,f0,lmk2,lmk3,f1){let l0,pse=void 0,lmk=[lmk0,lmk1,lmk2,lmk3],lmp=Array(4);for(let i=0;i<4;++i){let l1=this.landmarkFromAnatID(lmk[i]);if(void 0===l1){lmp=void 0;break}if(lmp[i]=l1.position,i>0&&l0.paths[0]!==l1.paths[0]&&(lmp=void 0),void 0===lmp)break;l0=l1}return void 0!==lmp&&(pse=[l0.paths[0],Number(lmp[0])+Math.floor(f0*(lmp[1]-lmp[0])),Number(lmp[2])+Math.floor(f1*(lmp[3]-lmp[2]))]),pse}landmarkFromAnatID(id){var lmk=void 0;let lmks=this._config.landmarks;for(let li=0;li<lmks.length;++li){let l=lmks[li];if(l.anatomy[0].id===id){lmk=l;break}}return lmk}addTrack(name,path_id,start_idx,end_idx,col,dist,ang){let path=void 0,path_idx=this._config.pathIdToIdx[path_id];if(void 0!==path_idx){if(path=this._config.paths[path_idx],start_idx>end_idx){let i=start_idx;start_idx=end_idx,end_idx=i}start_idx<0&&(start_idx=0),end_idx>=path.n&&(end_idx=path.n-1);let pts=[],tgt=[];var cad=Math.cos(ang)*dist,sad=Math.sin(ang)*dist;for(let i=start_idx;i<=end_idx;++i){let pp=path.points[i],pr=path.normals[i],pt=path.tangents[i],ps=[pt[1]*pr[2]-pr[1]*pt[2],pt[2]*pr[0]-pr[2]*pt[0],pt[0]*pr[1]-pr[0]*pt[1]];pts.push([pp[0]+(cad*pr[0]+sad*ps[0]),pp[1]+(cad*pr[1]+sad*ps[1]),pp[2]+(cad*pr[2]+sad*ps[2])]),tgt.push([pt[0],pt[1],pt[2]])}let m_name=this.getTrackName(name),dsp=path.display_props;this._ren.addModel({name:m_name,mode:MARenderMode.PATH,color:col,linewidth:dsp.line_width,vertices:pts,tangents:tgt})}}removeTrack(name){this._ren.removeModel(this.getTrackName(name))}setPosition(pmk0,pmk1,pdt,smk0,smk1,sdt,emk0,emk1,edt){let p=this._indexOnPath(pmk0,pmk1,pdt),rs=this._indexOnPath(smk0,smk1,sdt),re=this._indexOnPath(emk0,emk1,edt);this._updatePosition(p[0],p[1],rs[1],re[1])}setDiscRadius(rad){let dsc=this._config.disc,dsp=dsc.display_props;dsp.radius=rad;let pd=this._config.paths[this._curPath],vtx=pd.points[this._curPathIdx],tan=pd.tangents[this._curPathIdx],ext=dsp.thickness;Boolean(ext)||(ext=1),this._ren.updateModel({name:this.getDiscName(dsc.id),size:rad,position:new THREE.Vector3(vtx[0],vtx[1],vtx[2]),normal:new THREE.Vector3(tan[0],tan[1],tan[2]),extrude:ext})}animate(){this._ren.animate()}getPosition(path,path_idx){let rtn=void 0,landmarks=this._config.landmarks,lmks=[void 0,void 0],pi=[-1,-1];for(let i=0;i<landmarks.length;++i){let pinp=-1,lmk=landmarks[i];for(let j=0;j<lmk.paths.length;++j)if(path===lmk.paths[j]){pinp=j;break}pinp>=0&&(lmk.position[pinp]<=path_idx&&(void 0===lmks[0]||i>lmks[0])&&(pi[0]=pinp,lmks[0]=i),lmk.position[pinp]>=path_idx&&(void 0===lmks[1]||i<lmks[1])&&(pi[1]=pinp,lmks[1]=i))}if(void 0!==lmks[0]&&void 0!==lmks[1]){let p0=landmarks[lmks[0]].position[pi[0]],p1=landmarks[lmks[1]].position[pi[1]];rtn=[lmks[0],lmks[1],(path_idx-p0)/(p1-p0)]}return rtn}getSectionImage(){let img=void 0;if(Boolean(this._config.section_files)&&this._config.section_files.length>this._curPath){let sf=this._config.section_files[this._curPath],template=sf.filename,rx=/%([0 ]?)(\d*)d/,fmt=template.match(rx),n=parseInt(fmt[2])||0,d=String(this._curPathIdx);n>d.length&&(d=fmt[1].repeat(n-d.length)+d),img=this._config.model_dir+sf.filepath+"/"+template.replace(rx,d)}return img}positionToPath(pos,tol){let fnd=[0,0,Number.MAX_VALUE],pv=new THREE.Vector3(pos[0],pos[1],pos[2]);for(let pi=0;pi<this._config.paths.length;++pi){let path=this._config.paths[pi];for(let pj=0;pj<path.n;++pj){let pp=path.points[pj],d2=pv.distanceToSquared(new THREE.Vector3(pp[0],pp[1],pp[2]));d2<fnd[2]&&(fnd[0]=pi,fnd[1]=pj,fnd[2]=d2)}}return fnd[2]<tol?fnd[2]=Math.sqrt(fnd[2]):fnd=void 0,fnd}getAnatomyConfig(id){let an=void 0,all_an=this._config.anatomy_surfaces;for(let i=0;i<all_an.length;++i)if(all_an[i].id===id){an=all_an[i];break}return an}getReferenceName(){return this.referenceNamePrefix+this.nameSep+this._config.reference_surfaces.id}getAnatomyName(id){return this.anatomyNamePrefix+this.nameSep+id}getDiscName(id){return this.discNamePrefix+this.nameSep+id}getPathName(id){let pix=this._config.pathIdToIdx[id];return this.pathNamePrefix+this.nameSep+pix}getLandmarkName(id){return this.landmarkNamePrefix+this.nameSep+id}getLandmarkLblName(id){return this.landmarkNameLblPrefix+this.nameSep+id}getMarkerName(id){return this.markerNamePrefix+this.nameSep+id}getMarkerLblName(id){return this.markerNameLblPrefix+this.nameSep+id}getTrackName(id){return this.trackNamePrefix+this.nameSep+id}findDispObj(gca_grp,gca_id){return this._findDispObjs(gca_grp,gca_id,!1)}findAllDispObj(gca_grp,gca_id){return this._findDispObjs(gca_grp,gca_id,!0)}_isDefined(x){return void 0!==x}_isArray(obj){return"[object Array]"===Object.prototype.toString.call(obj)}_isString(obj){return"[object String]"===Object.prototype.toString.call(obj)}_clamp(v,mn,mx){return v<mn?mn:v>mx?mx:v}_baryCoords(t,p){let b=void 0,t0=t[0],v0=new THREE.Vector3(t[1].x-t0.x,t[1].y-t0.y,t[1].z-t0.z),v1=new THREE.Vector3(t[2].x-t0.x,t[2].y-t0.y,t[2].z-t0.z),v2=new THREE.Vector3(p.x-t0.x,p.y-t0.y,p.z-t0.z),d00=v0.dot(v0),d01=v0.dot(v1),d11=v1.dot(v1),d20=v2.dot(v0),d21=v2.dot(v1),d=d00*d11-d01*d01;return d>0&&(d=1/d,(b=new Array(3))[1]=d*(d11*d20-d01*d21),b[2]=d*(d00*d21-d01*d20),b[0]=1-b[1]-b[2]),b}_loadJson(url){let obj=void 0,req=new XMLHttpRequest;return req.open("GET",url,!1),req.overrideMimeType("text/html"),req.send(null),200===req.status&&(obj=JSON.parse(req.responseText)),obj}_setConfig(cfg){this._config=cfg,this._config.model_dir||(this._config.model_dir=""),this._sortCfgLandmarks(cfg),this._findCfgPaths(),this._findCfgModelObjects(),this._findCfgViews(),this._ren.markerSizeSet(this._config.display_props.marker_size)}_loadPaths(){for(let i=0,l=this._config.paths.length;i<l;++i){let path=this._config.paths[i],path_data=this._loadJson(this._config.model_dir+path.filepath+"/"+path.spline_filename);path.n=path_data.n,path.points=path_data.points,path.tangents=path_data.tangents,void 0!==path_data.normals&&(path.normals=path_data.normals)}}_sortCfgLandmarks(cfg){cfg.landmarks.sort((a,b)=>{return a.position[0]-b.position[0]})}_findCfgModelObjects(){let cfg=this._config;for(const i in cfg.model_objects){let mo=cfg.model_objects[i];if(this._isDefined(mo)&&this._isDefined(mo.group))switch(mo.group){case"GLOBAL_DISPLAY_PROP":cfg.display_props=mo.display_props;break;case"DISC":cfg.disc=mo;break;case"SECTION_FILES":this._isDefined(cfg.section_files)||(cfg.section_files=[]);let pi=cfg.pathIdToIdx[mo.path];cfg.section_files[pi]=mo;break;case"REFERENCE_SURFACES":this._isDefined(cfg.reference_surfaces)||(cfg.reference_surfaces=[]),cfg.reference_surfaces.push(mo);break;case"ANATOMY_SURFACES":this._isDefined(cfg.anatomy_surfaces)||(cfg.anatomy_surfaces=[]),cfg.anatomy_surfaces.push(mo)}}}_findCfgPaths(){this._config.pathIdToIdx=[];for(let i=0;i<this._config.paths.length;++i){let p=this._config.paths[i];this._config.pathIdToIdx[p.id]=i}}_findCfgViews(){let gdp=this._config.display_props;gdp.viewTypeToIdx=[];for(const i in gdp.model_views){let v=gdp.model_views[i];gdp.viewTypeToIdx[v.type]=i}}_indexOnPath(lmid0,lmid1,dst){let path=void 0,path_idx=void 0,index=void 0,mi=[-1,-1],mpi=[-1,-1],mp=[[],[]],li=0,ll=this._config.landmarks.length;for(;(mi[0]<0||mi[1]<0)&&li<ll;){let lmk=this._config.landmarks[li];lmk.id===lmid0&&(mi[0]=li,mp[0]=lmk.paths),lmk.id==lmid1&&(mi[1]=li,mp[1]=lmk.paths),++li}if(mi[0]>-1&&mi[1]>-1){li=0,ll=mp[0].length;let jl=mp[1].length;for(;void 0===path_idx&&li<ll;){for(let ji=0;ji<jl;++ji)mp[0][li]===mp[1][ji]&&(mpi[0]=li,mpi[1]=ji,path=mp[0][li],path_idx=this._config.pathIdToIdx[path]);++li}if(void 0!==path_idx){let i0=this._config.landmarks[mi[0]].position[mpi[0]],i1=this._config.landmarks[mi[1]].position[mpi[1]];index=i0+Math.floor((i1-i0)*dst),index=this._clamp(index,0,this._config.paths[path_idx].n-1)}}return[path_idx,index]}_updateColon(){let scene=this._ren.scene;for(let i=0,l=scene.children.length;i<l;++i){let child=scene.children[i];if("anatomy"===child.name.substring(0,7)){let s=child.name.split("_");if(s.length>1){let idx=parseInt(s[1]);if(idx>=0&&idx<this._config.anatomy_surfaces.length){let anat=this._config.anatomy_surfaces[idx];this._ren.updateModel({name:child.name,color:anat.color,opacity:anat.opacity})}}}}}_updatePosition(path,pathIdx,roiIdxSrt,roiIdxEnd){this._curPath=path,this._curPathIdx=pathIdx,this._roiIdx=[roiIdxSrt,roiIdxEnd];let pd=this._config.paths[this._curPath],dsc=this._config.disc,dsp=dsc.display_props,name=this.getDiscName(dsc.id),vtx=pd.points[this._curPathIdx],tan=pd.tangents[this._curPathIdx],ext=dsp.thickness;Boolean(ext)||(ext=1),this._ren.updateModel({name:name,size:dsp.radius,position:new THREE.Vector3(vtx[0],vtx[1],vtx[2]),normal:new THREE.Vector3(tan[0],tan[1],tan[2]),extrude:ext}),name="highlight";let vertices=pd.points.slice(this._roiIdx[0],this._roiIdx[1]),tangents=pd.tangents.slice(this._roiIdx[0],this._roiIdx[1]);this._ren.getObjectByName(name)?this._ren.updateModel({name:name,bloom:!0,vertices:vertices,tangents:tangents}):this._ren.addModel({name:name,mode:MARenderMode.PATH,color:this._config.display_props.path_highlight_color,linewidth:this._config.display_props.path_highlight_width,vertices:vertices,tangents:tangents})}_findDispObjs(gca_grp,gca_id,all){let objs=[],scene=this._ren.scene;for(let i=0,l=scene.children.length;i<l;++i){let grp=void 0,id=void 0,obj=scene.children[i],tynm=obj.name.split(this.nameSep);if(tynm.length>1)switch(tynm[0]){case this.referenceNamePrefix:grp="REFERENCE_SURFACES",id=tynm[1];break;case this.anatomyNamePrefix:grp="ANATOMY_SURFACES",id=tynm[1];break;case this.discNamePrefix:grp="DISC",id=tynm[1];break;case this.pathNamePrefix:grp="PATHS",id=tynm[1];break;case this.trackNamePrefix:grp="TRACKS",id=tynm[1];break;case this.landmarkNamePrefix:case this.landmarkNameLblPrefix:grp="LANDMARKS",id=tynm[1];break;case this.markerNamePrefix:case this.markerNameLblPrefix:grp="MARKERS",id=tynm[1]}if((!this._isDefined(gca_grp)||this._isDefined(grp)&&gca_grp==grp)&&(!this._isDefined(gca_id)||this._isDefined(id)&&gca_id==id)){if(!all){objs=[grp,obj];break}objs.push([grp,obj])}}return objs}_picker(ev){if(ev&&ev.type&&"pick"===ev.type&&this._picker){let idx={pth:-1,mkm:-1,ana:-1,trk:-1},cnt=[],objA=[],typA=[],namA=[],posA=[],triA=[];for(let i=0,l=ev.hitlist.length;i<l;++i){let hit=ev.hitlist[i],obj=hit.object;if(obj&&obj.name){let tynm=obj.name.split(this.nameSep);tynm.length>1&&(tynm.length>2&&(tynm=[tynm[0],tynm.slice(1).join(this.nameSep)]),tynm[0]===this.pathNamePrefix?idx.pth<0?(idx.pth=objA.length,cnt.push(1),objA.push(obj),typA.push(tynm[0]),namA.push(tynm[1]),posA.push(hit.point),triA.push(0)):tynm[1]===namA[idx.pth]&&(++cnt[idx.pth],posA[idx.pth].add(hit.point)):tynm[0]===this.landmarkNamePrefix||tynm[0]===this.markerNamePrefix?idx.mkm<0?(idx.mkm=objA.length,cnt.push(1),objA.push(obj),typA.push(tynm[0]),namA.push(tynm[1]),posA.push(hit.point),triA.push(0)):tynm[0]===typA[idx.pth]&&tynm[1]===namA[idx.pth]&&(++cnt[idx.pth],posA[idx.pth].add(hit.point)):tynm[0]===this.trackNamePrefix?idx.trk<0&&(idx.trk=objA.length,cnt.push(1),objA.push(obj),typA.push(tynm[0]),namA.push(tynm[1]),posA.push(hit.point)):tynm[0]===this.anatomyNamePrefix&&idx.ana<0&&(idx.ana=objA.length,cnt.push(1),objA.push(obj),typA.push(tynm[0]),namA.push(tynm[1]),posA.push(hit.point),triA.push(hit.faceIndex)))}}if(objA.length>0){for(let i=0;i<objA.length;++i)if(typA[i]===this.anatomyNamePrefix){let g=objA[i].geometry,an=this.getAnatomyConfig(namA[i]);if(this._isDefined(an)&&this._isDefined(an.mapping)&&this._isDefined(g.index)&&this._isDefined(g.attributes.position)){let t=3*triA[i],ti=[g.index.array[t],g.index.array[t+1],g.index.array[t+2]],p=g.attributes.position.array,tv=new Array(3),mp=new Array(3);for(let j=0;j<3;++j){let v=3*ti[j];mp[j]=an.mapping[ti[i]],tv[j]=new THREE.Vector3(p[v],p[v+1],p[v+2])}let tw=this._baryCoords(tv,posA[i]),pi=Math.floor(mp[0]*tw[0]+mp[1]*tw[1]+mp[2]*tw[2]),path=this._config.paths[this._curPath];pi=this._clamp(pi,0,path.n-1),posA[i]=path.points[pi]}else objA[i]=void 0}else{let p=posA[i].divideScalar(cnt[i]);posA[i]=[p.x,p.y,p.z]}for(let i=objA.length-1;i>=0;--i)this._isDefined(objA[i])||(objA.splice(i,1),typA.splice(i,1),namA.splice(i,1),posA.splice(i,1))}objA.length>0&&this._pickerFn(ev,objA,typA,namA,posA)}}}export{GCA3DRenderer};
