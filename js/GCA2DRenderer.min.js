GCA2DRenderer=function(win,con,post_load_fn,pick_fn){var self=this;this.type="GCA2DRenderer",Object.defineProperty(self,"version",{value:"0.0.1",writable:!1}),this._win=win,this._container=con,this._pick_fn=pick_fn,this._post_load_fn=post_load_fn,this._canvas=void 0,this._config=void 0,this._cursor=void 0,this._pointer={button:0,drag:!1,drag_threshold_start:9,drag_threshold_end:1,position:new fabric.Point(0,0)},this._model_grp=void 0,this._markers_grp=void 0,this._landmarks_grp=void 0,this._ref_image=void 0,this._paths=void 0,this._roi=void 0,this._anat_images={},this._file_load_cnt=0,this._debug=!0,this._curPath=0,this._curPathIdx=0,this._roiIdx=[0,0],this._debug=!1,this._icons={pin:{url:"icons/pin.svg",prg:void 0},cursor:{url:"icons/cursor.svg",prg:void 0}},this._mapGroupsGCAToDisp={},this._layers={REFERENCE_IMAGES:10,ANATOMY_IMAGES:20,PATHS:40,ROI:50,CURSOR:60,LANDMARKS:70,MARKERS:80},this.init=function(cfg){let c=document.createElement("canvas");c.setAttribute("id","canvas"),self._container.appendChild(c),self._canvas=new fabric.Canvas("canvas",{selection:!1,fireRightClick:!0,stopContextMenu:!0}),self._isArray(cfg)&&(cfg=cfg[0]),this._sortLandmarks(cfg),self._config=cfg,this._findDisplayProps(),this._isDefined(self._config.display_props.pick_precision)&&(self._config.display_props.pick_precision=1),self._canvas.hoverCursor="default",self._model_grp=new fabric.Group,self._markers_grp=new fabric.Group,self._landmarks_grp=new fabric.Group,self._canvas.add(self._model_grp),self._canvas.add(self._markers_grp),self._canvas.add(self._landmarks_grp),self._canvas.on("mouse:down",this._onMouseDown),self._canvas.on("mouse:up",this._onMouseUp),self._canvas.on("mouse:move",this._onMouseMove),self._canvas.on("mouse:wheel",this._onMouseWheel),self._container.onresize=this._onResize,self._win.addEventListener("resize",this._onResize)},this.getConfig=function(){return self._config},this.loadModels=function(){this._startLoad(),this._loadIcons(),this._loadImages(),this._loadPaths(),this._endLoad()},this.setProperties=function(grp,id,prop){let d_itm,d_grp;[d_grp,d_itm]=this.findDispObj(grp,id),this._isDefined(d_grp)&&this._isDefined(d_itm)&&(d_itm.set(prop),self._canvas.renderAll())},this.getProperty=function(grp,id,prop){let d_itm,d_grp,val=void 0;return[d_grp,d_itm]=this.findDispObj(grp,id),this._isDefined(d_grp)&&this._isDefined(d_itm)&&(val=d_itm.get(prop)),val},this.setPosition=function(pmk0,pmk1,pdt,smk0,smk1,sdt,emk0,emk1,edt){let p=self._positionOnPath(pmk0,pmk1,pdt),rs=self._positionOnPath(smk0,smk1,sdt),re=self._positionOnPath(emk0,emk1,edt);this._updatePosition(p[0],p[1],rs[1],re[1])},this._positionOnPath=function(lmid0,lmid1,dst){let path=void 0,index=void 0,path_index=void 0,mi=[-1,-1],mpi=[-1,-1],mp=[[],[]],li=0,ll=self._config.landmarks.length;for(;(mi[0]<0||mi[1]<0)&&li<ll;){let lmk=self._config.landmarks[li];lmk.id===lmid0&&(mi[0]=li,mp[0]=lmk.paths),lmk.id==lmid1&&(mi[1]=li,mp[1]=lmk.paths),++li}if(mi[0]>-1&&mi[1]>-1){li=0,ll=mp[0].length;let jl=mp[1].length;for(;void 0===path&&li<ll;){for(let ji=0;ji<jl;++ji)mp[0][li]===mp[1][ji]&&(mpi[0]=li,mpi[1]=ji,path=mp[0][li]);++li}if(void 0!==path){path_index=self._pathIdxFromID(path);let i0=self._config.landmarks[mi[0]].position[mpi[0]],i1=self._config.landmarks[mi[1]].position[mpi[1]];index=i0+Math.floor((i1-i0)*dst),index=this._clamp(index,0,self._config.paths[path_index].n-1)}}return[path_index,index]},this._updatePosition=function(path,pathIdx,roiIdxSrt,roiIdxEnd){self._curPath=path,self._curPathIdx=pathIdx;let pd=self._config.paths[self._curPath];roiIdxSrt<0&&(roiIdxSrt=0),roiIdxEnd>=pd.n&&(roiIdxEnd=pd.n-1),self._roiIdx=[roiIdxSrt,roiIdxEnd];let pos=pd.points[self._curPathIdx],tan=pd.tangents[self._curPathIdx],rot=Math.floor(180*Math.atan2(-tan.x,tan.y)/Math.PI);self._cursor.set({angle:rot}),self._cursor.setPositionByOrigin(pos,"center","center"),self._canvas.moveTo(self._cursor,self._layers.CURSOR);let cp=self._config.paths[self._curPath],gdp=self._config.display_props;self._canvas.remove(self._roi),self._roi=this._makePath(cp.points.slice(self._roiIdx[0],self._roiIdx[1]+1),cp.id,{color:this._parseColor(gdp.path_roi.color),width:gdp.path_roi.line_width,opacity:gdp.path_roi.opacity,visible:gdp.path_roi.visible}),self._model_grp.add(self._roi),self._canvas.moveTo(self._roi,self._layers.ROI),self._mapGroupsGCAToDisp.ROI=self._model_grp,self._canvas.renderAll()},this.findDispObj=function(gca_grp,gca_id){let d_itm=void 0,d_grp=self._mapGroupsGCAToDisp[gca_grp];if(this._isDefined(d_grp))for(let i=0;i<d_grp._objects.length;++i){let itm=d_grp._objects[i];if(this._isDefined(itm.gca_id)&&this._isDefined(itm.gca_group)&&gca_grp==itm.gca_group&&(!this._isDefined(gca_id)||gca_id==itm.gca_id)){d_itm=itm;break}}return[d_grp,d_itm]},this.findAllDispObj=function(gca_grp,gca_id){let objs=[];for(let k in self._mapGroupsGCAToDisp)if(!this._isDefined(gca_grp)||k===gca_grp){let d_grp=self._mapGroupsGCAToDisp[k];if(this._isDefined(d_grp))for(let i=0;i<d_grp._objects.length;++i){let itm=d_grp._objects[i];!this._isDefined(itm.gca_id)||!this._isDefined(itm.gca_group)||k!=itm.gca_group||this._isDefined(gca_id)&&gca_id!=itm.gca_id||objs.push([d_grp,itm])}}return objs},this._sortLandmarks=function(cfg){cfg.landmarks.sort((a,b)=>a.position[0]-b.position[0])},this._findDisplayProps=function(){for(const i in self._config.model_objects){let mo=self._config.model_objects[i];this._isDefined(mo)&&this._isDefined(mo.group)&&"GLOBAL_DISPLAY_PROP"===mo.group&&this._isDefined(mo.display_props)&&(self._config.display_props=mo.display_props)}},this._loadIcons=function(){for(const k in self._icons)this._loadSvg(self._icons[k].url,function(obj){self._icons[k].prg=obj})},this._loadImages=function(){if(this._isDefined(self._config.model_objects))for(im=0;im<self._config.model_objects.length;++im){let obj=self._config.model_objects[im];switch(obj.group){case"REFERENCE_IMAGES":this._isDefined(self._ref_image)||this._loadImage(obj.filepath+"/"+obj.filename,function(img){self._ref_image=img});break;case"ANATOMY_IMAGES":this._isDefined(self._anat_images[obj.id])||this._loadImage(obj.filepath+"/"+obj.filename,function(img){self._anat_images[obj.id]=img})}}},this._loadPaths=function(){for(let i=0;i<self._config.paths.length;++i){let path=self._config.paths[i];this._loadJson(path.filepath+"/"+path.spline_filename,function(obj){path.n=obj.n,path.points=obj.points,path.tangents=obj.tangents;let op=obj.points,ot=obj.tangents,np=[],nt=[];for(let j=0;j<obj.n;++j)np[j]=new fabric.Point(op[j][0],op[j][1]),nt[j]=new fabric.Point(ot[j][0],ot[j][1]);path.points=np,path.tangents=nt}),this._loadJson(path.filepath+"/"+path.map_filename,function(obj){path.mapping=obj})}},this._createVisualisation=function(){let dp=self._config.display_props;if(this._isDefined(self._config.model_objects))for(pass=0;pass<2;++pass)for(im=0;im<self._config.model_objects.length;++im){let img=void 0,obj=self._config.model_objects[im],odp=obj.display_props;switch(obj.group){case"REFERENCE_IMAGES":if(0==pass){if(this._isDefined(odp)||(obj.display_props={}),this._isDefined(odp.opacity)||(odp.opacity=1),this._isDefined(odp.invert)||(odp.invert=!1),(img=self._ref_image).set({opacity:odp.opacity,selectable:!1}),img.gca_id=obj.id,img.gca_group=obj.group,odp.invert){let flt=new fabric.Image.filters.Invert;img.filters.push(flt),img.applyFilters()}self._model_grp.add(img),self._canvas.moveTo(img,self._layers.REFERENCE_IMAGES),self._mapGroupsGCAToDisp.REFERENCE_IMAGES=self._model_grp}break;case"ANATOMY_IMAGES":if(0!=pass&&(img=self._anat_images[obj.id],this._isDefined(img))){this._isDefined(odp)||(obj.display_props={}),this._isDefined(odp.opacity)||(odp.opacity=1),this._isDefined(odp.color)||(odp.color="0xffffff"),img.set({opacity:odp.opacity,selectable:!1});let flt=new fabric.Image.filters.BlendColor({color:this._parseColor(odp.color)});img.filters.push(flt),img.applyFilters(),img.gca_id=obj.id,img.gca_group=obj.group,self._model_grp.add(img),self._canvas.moveTo(img,self._layers.ANATOMY_IMAGES),self._mapGroupsGCAToDisp.ANATOMY_IMAGES=self._model_grp}}}if(this._isDefined(self._config.paths)){for(this._isDefined(this._paths)||(this._paths=[]),pi=0;pi<self._config.paths.length;++pi){let cp=self._config.paths[pi],pdp=cp.display_props;self._paths[pi]=this._makePath(cp.points,cp.id,{color:this._parseColor(pdp.color),width:pdp.line_width,opacity:pdp.opacity,visible:pdp.is_visible}),self._model_grp.add(self._paths[pi]),self._canvas.moveTo(self._paths[pi],self._layers.PATHS),self._mapGroupsGCAToDisp.PATHS=self._model_grp}let cp=self._config.paths[self._curPathIdx];self._roi=this._makePath(cp.points.slice(self._roiIdx[0],self._roiIdx[1]+1),cp.id,{color:this._parseColor(dp.path_roi.color),width:dp.path_roi.line_width,opacity:dp.path_roi.opacity,visible:dp.path_roi.visible}),self._model_grp.add(self._roi),self._canvas.moveTo(self._roi,self._layers.ROI),self._mapGroupsGCAToDisp.ROI=self._model_grp}if(this._isDefined(self._config.landmarks)){let lmks=self._config.landmarks;for(il=0;il<lmks.length;++il){let l=lmks[il],pi=self._pathIdxFromID(l.paths[0]),pos=self._config.paths[pi].points[l.position[0]],ana=l.anatomy[0],ldp=this._isDefined(l.display_props)?l.display_props:l,lmk=this._makeMarker("pin",pos,l.id,"LANDMARKS",{color:this._parseColor(ldp.color),visible:ldp.is_visible}),lbl_pos=new fabric.Point(pos.x,pos.y);if(this._isDefined(ldp.label_offset)&&this._isArray(ldp.label_offset)&&ldp.label_offset.length>0){let ms=self._config.display_props.marker_size;lbl_pos.x+=ldp.label_offset[0]*ms,lbl_pos.y+=ldp.label_offset[1]*ms}lbl=this._makeLabel(lbl_pos,ana.abbreviated_name,l.id,"LANDMARK_LABELS",{font_size:self._config.display_props.label_font_size,color:this._parseColor(ldp.color)}),self._landmarks_grp.add(lmk),self._landmarks_grp.add(lbl),self._canvas.moveTo(lmk,self._layers.LANDMARKS),self._canvas.moveTo(lbl,self._layers.LANDMARKS),self._mapGroupsGCAToDisp.LANDMARKS=self._landmarks_grp,self._mapGroupsGCAToDisp.LANDMARK_LABELS=self._landmarks_grp}}let cdp=dp.cursor;self._cursor=this._makeCursor({color:cdp.color,size:cdp.size}),self._cursor.gca_group="CURSOR",self._model_grp.add(self._cursor),self._canvas.moveTo(self._cursor,self._layers.CURSOR),self._mapGroupsGCAToDisp.CURSOR=self._model_grp,self._mapGroupsGCAToDisp.MARKERS=self._markers_grp,self._mapGroupsGCAToDisp.MARKER_LABELS=self._markers_grp,self._onResize()},this._makeCursor=function(prop){const def={color:16777215,size:11};let sz=this._defordef(prop,def,"size"),color=this._parseColor(this._defordef(prop,def,"color")),cursor=fabric.util.object.clone(self._icons.cursor.prg);return cursor.scaleToHeight(sz),cursor.set({stroke:color,strokeWidth:sz/6+1,fill:"rgba(0,0,0,0)"}),cursor},this._makePath=function(pts,id,prop){const def={color:16777215,width:3,opacity:1,visible:!0};let pth=new fabric.Polyline(pts,{fill:"transparent",selectable:!1});return pth.set({stroke:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),strokeWidth:this._defordef(prop,def,"width"),visible:this._defordef(prop,def,"visible")}),pth.gca_id=id,pth.gca_group="PATHS",pth},this._makeMarker=function(key,pos,id,grp,prop){const def={color:16777215,opacity:1,marker_size:24,visible:!0};let mrk=fabric.util.object.clone(self._icons[key].prg),hgt=this._defordef(self._config.display_props,def,"marker_size");mrk.scaleToHeight(hgt),mrk.gca_id=id,mrk.gca_group=grp,mrk.gca_position=new fabric.Point(pos.x,pos.y);let r=mrk.getBoundingRect();return mrk.left=pos.x-r.width/2,mrk.top=pos.y-hgt,mrk.set({stroke:this._parseColor(this._defordef(prop,def,"color")),fill:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),visible:this._defordef(prop,def,"visible"),selectable:!1}),mrk},this._makeLabel=function(pos,txt,id,grp,prop){const def={color:16777215,font_size:14,opacity:1,visible:!0};let lbl=new fabric.Text(""+txt,{stroke:this._parseColor(this._defordef(prop,def,"color")),fill:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),visible:this._defordef(prop,def,"visible"),fontSize:this._defordef(prop,def,"font_size"),fontWeight:"bold",selectable:!1});return lbl.left=pos.x,lbl.top=pos.y,lbl.gca_id=id,lbl.gca_group=grp,lbl},this._pathIdxFromID=function(id){let pi=void 0,paths=self._config.paths;for(let i=0;i<paths.length;++i){if(paths[i].id==id){pi=i;break}}return pi},this._getObjValue=function(map,x,y){var vidx,inside=!1,v=void 0,obj=map.object,dom=obj.domain,val=obj.values;if(x=Math.trunc(x)-dom.kol1,(y=Math.trunc(y)-dom.line1)>=0&&y<=dom.lastln-dom.line1&&x>=0&&x<=dom.lastkl-dom.kol1){var ivln=dom.intvlines[y];vidx=val.value_line_indices[y];for(let i=0;!inside&&i<ivln.length;++i){if(iv=ivln[i],x>=iv[0]&&x<=iv[1]){vidx+=x-iv[0],inside=!0;break}vidx+=iv[1]-iv[0]+1}}return inside&&(v=val.values[vidx]),v},this.mapPointToMidline=function(p){let q=void 0,cp=self._config.paths[self._curPath],idx=self._getObjValue(cp.mapping,p.x,p.y);return void 0!==idx&&(b=cp.points[idx]),void 0!==idx&&(q={x:b.x,y:b.y,i:idx}),q},this.addMarker=function(id,pos,txt,props){let spos=new fabric.Point(pos.x,pos.y),mpos=this.mapPointToMidline(spos);if(this._isDefined(mpos)){let mrk=this._makeMarker("pin",mpos,id,"MARKERS",props);if(self._markers_grp.add(mrk),self._canvas.moveTo(mrk,self._layers.MARKERS),this._isDefined(txt)){let lbl=this._makeLabel(mpos,txt,id,"MARKER_LABELS",props);self._markers_grp.add(lbl),self._canvas.moveTo(lbl,self._layers.MARKERS)}}},this.removeMarker=function(id){let m_itm,l_itm,l_grp;[m_grp,m_itm]=this.findDispObj("MARKERS",id),[l_grp,l_itm]=this.findDispObj("MARKER_LABELS",id),this._isDefined(m_grp)&&this._isDefined(m_itm)&&(self._canvas.remove(m_itm),self._markers_grp.remove(m_itm)),this._isDefined(l_grp)&&this._isDefined(l_itm)&&(self._canvas.remove(l_itm),self._markers_grp.remove(l_itm))},this.landmarkFromID=function(id){var lmk=void 0;let lmks=self._config.landmarks;for(let li=0;li<lmks.length;++li){let l=lmks[li];if(l.id===id){lmk=l;break}}return lmk},this.positionToPath=function(pos,tol){let fnd=[0,0,Number.MAX_VALUE],pv=new fabric.Point(pos.x,pos.y);for(let pi=0;pi<self._config.paths.length;++pi){let path=self._config.paths[pi];for(let pj=0;pj<path.n;++pj){let pp=path.points[pj],pq=new fabric.Point(pp.x-pv.x,pp.y-pv.y),d2=pq.x*pq.x+pq.y*pq.y;d2<fnd[2]&&(fnd[0]=pi,fnd[1]=pj,fnd[2]=d2)}}return fnd[2]<tol?fnd[2]=Math.sqrt(fnd[2]):fnd=void 0,fnd},this._onMouseDown=function(e){self._pointer.button=e.button,self._pointer.drag=!1,self._pointer.position=new fabric.Point(e.pointer.x,e.pointer.y)},this._onMouseMove=function(e){if(1==self._pointer.button){let del=new fabric.Point(e.pointer.x-self._pointer.position.x,e.pointer.y-self._pointer.position.y),del2=del.x*del.x+del.y*del.y;del2>self._pointer.drag_threshold_start?self._pointer.drag=!0:del2<self._pointer.drag_threshold_end&&(self._pointer.drag=!1),self._pointer.drag&&self._canvas.relativePan(del),self._pointer.position=new fabric.Point(e.pointer.x,e.pointer.y)}},this._onMouseUp=function(e){if(1==self._pointer.button&&!self._pointer.drag){let pos=new fabric.Point(e.pointer.x,e.pointer.y),inv=fabric.util.invertTransform(self._canvas.viewportTransform);pos=fabric.util.transformPoint(pos,inv),self._isDefined(self._pick_fn)&&self._pick_fn(self,pos)}self._pointer.drag=!1,self._pointer.button=0},this._onMouseWheel=function(opt){let e=opt.e;self._updateZoom(new fabric.Point(e.offsetX,e.offsetY),e.deltaY),e.preventDefault()},this._onResize=function(){self._isDefined(self._container)&&self._isDefined(self._canvas)&&(self._canvas.setHeight(self._container.clientHeight),self._canvas.setWidth(self._container.clientWidth),self._setZoom())},this._setZoom=function(){if(this._isDefined(self._canvas)&&this._isDefined(self._ref_image)){let sx=self._canvas.width/self._ref_image.width,sy=self._canvas.height/self._ref_image.height,s=sx<sy?sx:sy;s>1&&(s=1);self._canvas.width,self._canvas.height;self._canvas.zoomToPoint(new fabric.Point(0,0),s),self._debug&&console.log("DEBUG viewportTransform "+self._canvas.viewportTransform[0]+" "+self._canvas.viewportTransform[1]+" "+self._canvas.viewportTransform[2]+" "+self._canvas.viewportTransform[3]+" "+self._canvas.viewportTransform[4]+" "+self._canvas.viewportTransform[5])}},this._updateZoom=function(pos,del){let z=self._canvas.getZoom()*.95**Math.sign(del);self._canvas.zoomToPoint(pos,z)},this._loadJson=function(url,on_load){self._preLoad();let req=new XMLHttpRequest;req.open("GET",url,!1),req.onreadystatechange=function(){200===req.status?(obj=JSON.parse(req.responseText),on_load(obj),self._postLoad()):alert("Failed to load JSON file "+url+".")},req.send()},this._loadImage=function(url,on_load){self._preLoad(),fabric.Image.fromURL(url,function(img,err){err?alert("Failed to load image file "+url+"."):(on_load(img),self._postLoad())})},this._loadSvg=function(url,on_load){self._preLoad(),fabric.loadSVGFromURL(url,function(obj){on_load(fabric.util.groupSVGElements(obj)),self._postLoad()})},this._startLoad=function(){self._file_load_cnt=1},this._preLoad=function(){++self._file_load_cnt},this._postLoad=function(){--self._file_load_cnt,self._file_load_cnt<=0&&(self._createVisualisation(),this._isDefined(self._post_load_fn)&&self._post_load_fn())},this._endLoad=function(){this._postLoad()},this._isDefined=function(x){return void 0!==x},this._isObject=function(x){return"object"==typeof x},this._isArray=function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},this._isString=function(obj){return"[object String]"===Object.prototype.toString.call(obj)},this._defordef=function(g,d,key){let v=void 0;return this._isDefined(g)&&key in g&&this._isDefined(g[key])?v=g[key]:this._isDefined(d)&&key in d&&(v=d[key]),v},this._clamp=function(v,mn,mx){return v<mn?mn:v>mx?mx:v},this._parseColor=function(gc){return this._isString(gc)?nc=gc.replace("0x","#"):nc=gc,nc}};
