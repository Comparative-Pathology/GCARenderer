class GCA2DRenderer{constructor(win,con,post_load_fn,pick_fn){this.type="GCA2DRenderer",Object.defineProperty(this,"version",{value:"2.0.0",writable:!1}),this._win=win,this._container=con,this._pick_fn=pick_fn,this._post_load_fn=post_load_fn,this._canvas=void 0,this._config=void 0,this._cursor=void 0,this._pointer={button:0,drag:!1,drag_threshold_start:9,drag_threshold_end:1,position:new fabric.Point(0,0)},this._model_grp=void 0,this._markers_grp=void 0,this._landmarks_grp=void 0,this._ref_image=void 0,this._paths=void 0,this._roi=void 0,this._anat_images={},this._file_load_cnt=0,this._debug=!0,this._curPath=0,this._curPathIdx=0,this._roiIdx=[0,0],this._debug=!1,this._icons={pin:{url:"icons/pin.svg",prg:void 0},cursor:{url:"icons/cursor.svg",prg:void 0}},this._mapGroupsGCAToDisp={},this._layers={REFERENCE_IMAGES:10,ANATOMY_IMAGES:20,PATHS:40,ROI:50,CURSOR:60,LANDMARKS:70,MARKERS:80}}init(cfg){let c=document.createElement("canvas");c.setAttribute("id","canvas"),this._container.appendChild(c),this._canvas=new fabric.Canvas("canvas",{selection:!1,fireRightClick:!0,stopContextMenu:!0}),this._isArray(cfg)&&(cfg=cfg[0]),this._sortLandmarks(cfg),this._config=cfg,this._findDisplayProps(),this._isDefined(this._config.display_props.pick_precision)&&(this._config.display_props.pick_precision=1),this._canvas.hoverCursor="default",this._model_grp=new fabric.Group,this._markers_grp=new fabric.Group,this._landmarks_grp=new fabric.Group,this._canvas.add(this._model_grp),this._canvas.add(this._markers_grp),this._canvas.add(this._landmarks_grp),this._canvas.on("mouse:down",this._onMouseDown.bind(this)),this._canvas.on("mouse:up",this._onMouseUp.bind(this)),this._canvas.on("mouse:move",this._onMouseMove.bind(this)),this._canvas.on("mouse:wheel",this._onMouseWheel.bind(this)),this._container.onresize=this._onResize.bind(this),this._win.addEventListener("resize",this._onResize.bind(this))}getConfig(){return this._config}loadModels(){this._startLoad(),this._loadIcons(),this._loadImages(),this._loadPaths(),this._endLoad()}setProperties(grp,id,prop){let d_itm,d_grp;[d_grp,d_itm]=this.findDispObj(grp,id),this._isDefined(d_grp)&&this._isDefined(d_itm)&&(d_itm.set(prop),this._canvas.renderAll())}getProperty(grp,id,prop){let d_itm,d_grp,val=void 0;return[d_grp,d_itm]=this.findDispObj(grp,id),this._isDefined(d_grp)&&this._isDefined(d_itm)&&(val=d_itm.get(prop)),val}setPosition(pmk0,pmk1,pdt,smk0,smk1,sdt,emk0,emk1,edt){let p=this._positionOnPath(pmk0,pmk1,pdt),rs=this._positionOnPath(smk0,smk1,sdt),re=this._positionOnPath(emk0,emk1,edt);this._updatePosition(p[0],p[1],rs[1],re[1])}_positionOnPath(lmid0,lmid1,dst){let path=void 0,index=void 0,path_index=void 0,mi=[-1,-1],mpi=[-1,-1],mp=[[],[]],li=0,ll=this._config.landmarks.length;for(;(mi[0]<0||mi[1]<0)&&li<ll;){let lmk=this._config.landmarks[li];lmk.id===lmid0&&(mi[0]=li,mp[0]=lmk.paths),lmk.id==lmid1&&(mi[1]=li,mp[1]=lmk.paths),++li}if(mi[0]>-1&&mi[1]>-1){li=0,ll=mp[0].length;let jl=mp[1].length;for(;void 0===path&&li<ll;){for(let ji=0;ji<jl;++ji)mp[0][li]===mp[1][ji]&&(mpi[0]=li,mpi[1]=ji,path=mp[0][li]);++li}if(void 0!==path){path_index=this._pathIdxFromID(path);let i0=this._config.landmarks[mi[0]].position[mpi[0]],i1=this._config.landmarks[mi[1]].position[mpi[1]];index=i0+Math.floor((i1-i0)*dst),index=this._clamp(index,0,this._config.paths[path_index].n-1)}}return[path_index,index]}_updatePosition(path,pathIdx,roiIdxSrt,roiIdxEnd){this._curPath=path,this._curPathIdx=pathIdx;let pd=this._config.paths[this._curPath];roiIdxSrt<0&&(roiIdxSrt=0),roiIdxEnd>=pd.n&&(roiIdxEnd=pd.n-1),this._roiIdx=[roiIdxSrt,roiIdxEnd];let pos=pd.points[this._curPathIdx],tan=pd.tangents[this._curPathIdx],rot=Math.floor(180*Math.atan2(-tan.x,tan.y)/Math.PI);this._cursor.set({angle:rot}),this._cursor.setPositionByOrigin(pos,"center","center"),this._canvas.moveTo(this._cursor,this._layers.CURSOR);let cp=this._config.paths[this._curPath],gdp=this._config.display_props;this._canvas.remove(this._roi),this._roi=this._makePath(cp.points.slice(this._roiIdx[0],this._roiIdx[1]+1),cp.id,{color:this._parseColor(gdp.path_roi.color),width:gdp.path_roi.line_width,opacity:gdp.path_roi.opacity,visible:gdp.path_roi.visible}),this._model_grp.add(this._roi),this._canvas.moveTo(this._roi,this._layers.ROI),this._mapGroupsGCAToDisp.ROI=this._model_grp,this._canvas.renderAll()}findDispObj(gca_grp,gca_id){let d_itm=void 0,d_grp=this._mapGroupsGCAToDisp[gca_grp];if(this._isDefined(d_grp))for(let i=0;i<d_grp._objects.length;++i){let itm=d_grp._objects[i];if(this._isDefined(itm.gca_id)&&this._isDefined(itm.gca_group)&&gca_grp==itm.gca_group&&(!this._isDefined(gca_id)||gca_id==itm.gca_id)){d_itm=itm;break}}return[d_grp,d_itm]}findAllDispObj(gca_grp,gca_id){let objs=[];for(let k in this._mapGroupsGCAToDisp)if(!this._isDefined(gca_grp)||k===gca_grp){let d_grp=this._mapGroupsGCAToDisp[k];if(this._isDefined(d_grp))for(let i=0;i<d_grp._objects.length;++i){let itm=d_grp._objects[i];!this._isDefined(itm.gca_id)||!this._isDefined(itm.gca_group)||k!=itm.gca_group||this._isDefined(gca_id)&&gca_id!=itm.gca_id||objs.push([d_grp,itm])}}return objs}_sortLandmarks(cfg){cfg.landmarks.sort((a,b)=>a.position[0]-b.position[0])}_findDisplayProps(){for(const i in this._config.model_objects){let mo=this._config.model_objects[i];this._isDefined(mo)&&this._isDefined(mo.group)&&"GLOBAL_DISPLAY_PROP"===mo.group&&this._isDefined(mo.display_props)&&(this._config.display_props=mo.display_props)}}_loadIcons(){for(const k in this._icons)this._loadSvg(this._icons[k].url,obj=>{this._icons[k].prg=obj})}_loadImages(){if(this._isDefined(this._config.model_objects))for(let im=0;im<this._config.model_objects.length;++im){let obj=this._config.model_objects[im];switch(obj.group){case"REFERENCE_IMAGES":this._isDefined(this._ref_image)||this._loadImage(obj.filepath+"/"+obj.filename,img=>{this._ref_image=img});break;case"ANATOMY_IMAGES":if(!this._isDefined(this._anat_images[obj.id])){const obj1=obj;this._loadImage(obj1.filepath+"/"+obj1.filename,img=>{this._anat_images[obj1.id]=img})}}}}_loadPaths(){for(let i=0;i<this._config.paths.length;++i){let path=this._config.paths[i];const path1=path;this._loadJson(path.filepath+"/"+path.spline_filename,obj=>{path1.n=obj.n,path1.points=obj.points,path1.tangents=obj.tangents;let op=obj.points,ot=obj.tangents,np=[],nt=[];for(let j=0;j<obj.n;++j)np[j]=new fabric.Point(op[j][0],op[j][1]),nt[j]=new fabric.Point(ot[j][0],ot[j][1]);path1.points=np,path1.tangents=nt}),this._loadJson(path.filepath+"/"+path.map_filename,obj=>{path1.mapping=obj})}}_createVisualisation(){let dp=this._config.display_props;if(this._isDefined(this._config.model_objects))for(let pass=0;pass<2;++pass)for(let im=0;im<this._config.model_objects.length;++im){let img=void 0,obj=this._config.model_objects[im],odp=obj.display_props;switch(obj.group){case"REFERENCE_IMAGES":if(0==pass){if(this._isDefined(odp)||(obj.display_props={}),this._isDefined(odp.opacity)||(odp.opacity=1),this._isDefined(odp.invert)||(odp.invert=!1),(img=this._ref_image).set({opacity:odp.opacity,selectable:!1}),img.gca_id=obj.id,img.gca_group=obj.group,odp.invert){let flt=new fabric.Image.filters.Invert;img.filters.push(flt),img.applyFilters()}this._model_grp.add(img),this._canvas.moveTo(img,this._layers.REFERENCE_IMAGES),this._mapGroupsGCAToDisp.REFERENCE_IMAGES=this._model_grp}break;case"ANATOMY_IMAGES":if(0!=pass&&(img=this._anat_images[obj.id],this._isDefined(img))){this._isDefined(odp)||(obj.display_props={}),this._isDefined(odp.opacity)||(odp.opacity=1),this._isDefined(odp.color)||(odp.color="0xffffff"),img.set({opacity:odp.opacity,selectable:!1});let flt=new fabric.Image.filters.BlendColor({color:this._parseColor(odp.color)});img.filters.push(flt),img.applyFilters(),img.gca_id=obj.id,img.gca_group=obj.group,this._model_grp.add(img),this._canvas.moveTo(img,this._layers.ANATOMY_IMAGES),this._mapGroupsGCAToDisp.ANATOMY_IMAGES=this._model_grp}}}if(this._isDefined(this._config.paths)){this._isDefined(this._paths)||(this._paths=[]);for(let pi=0;pi<this._config.paths.length;++pi){let cp=this._config.paths[pi],pdp=cp.display_props;this._paths[pi]=this._makePath(cp.points,cp.id,{color:this._parseColor(pdp.color),width:pdp.line_width,opacity:pdp.opacity,visible:pdp.is_visible}),this._model_grp.add(this._paths[pi]),this._canvas.moveTo(this._paths[pi],this._layers.PATHS),this._mapGroupsGCAToDisp.PATHS=this._model_grp}let cp=this._config.paths[this._curPathIdx];this._roi=this._makePath(cp.points.slice(this._roiIdx[0],this._roiIdx[1]+1),cp.id,{color:this._parseColor(dp.path_roi.color),width:dp.path_roi.line_width,opacity:dp.path_roi.opacity,visible:dp.path_roi.visible}),this._model_grp.add(this._roi),this._canvas.moveTo(this._roi,this._layers.ROI),this._mapGroupsGCAToDisp.ROI=this._model_grp}if(this._isDefined(this._config.landmarks)){let lmks=this._config.landmarks;for(let il=0;il<lmks.length;++il){let l=lmks[il],pi=this._pathIdxFromID(l.paths[0]),pos=this._config.paths[pi].points[l.position[0]],ana=l.anatomy[0],ldp=this._isDefined(l.display_props)?l.display_props:l,lmk=this._makeMarker("pin",pos,l.id,"LANDMARKS",{color:this._parseColor(ldp.color),visible:ldp.is_visible}),lbl_pos=new fabric.Point(pos.x,pos.y);if(this._isDefined(ldp.label_offset)&&this._isArray(ldp.label_offset)&&ldp.label_offset.length>0){let ms=this._config.display_props.marker_size;lbl_pos.x+=ldp.label_offset[0]*ms,lbl_pos.y+=ldp.label_offset[1]*ms}let lbl=this._makeLabel(lbl_pos,ana.abbreviated_name,l.id,"LANDMARK_LABELS",{font_size:this._config.display_props.label_font_size,color:this._parseColor(ldp.color)});this._landmarks_grp.add(lmk),this._landmarks_grp.add(lbl),this._canvas.moveTo(lmk,this._layers.LANDMARKS),this._canvas.moveTo(lbl,this._layers.LANDMARKS),this._mapGroupsGCAToDisp.LANDMARKS=this._landmarks_grp,this._mapGroupsGCAToDisp.LANDMARK_LABELS=this._landmarks_grp}}let cdp=dp.cursor;this._cursor=this._makeCursor({color:cdp.color,size:cdp.size}),this._cursor.gca_group="CURSOR",this._model_grp.add(this._cursor),this._canvas.moveTo(this._cursor,this._layers.CURSOR),this._mapGroupsGCAToDisp.CURSOR=this._model_grp,this._mapGroupsGCAToDisp.MARKERS=this._markers_grp,this._mapGroupsGCAToDisp.MARKER_LABELS=this._markers_grp,this._onResize()}_makeCursor(prop){const def={color:16777215,size:11};let sz=this._defordef(prop,def,"size"),color=this._parseColor(this._defordef(prop,def,"color")),cursor=fabric.util.object.clone(this._icons.cursor.prg);return cursor.scaleToHeight(sz),cursor.set({stroke:color,strokeWidth:sz/6+1,fill:"rgba(0,0,0,0)"}),cursor}_makePath(pts,id,prop){const def={color:16777215,width:3,opacity:1,visible:!0};let pth=new fabric.Polyline(pts,{fill:"transparent",selectable:!1});return pth.set({stroke:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),strokeWidth:this._defordef(prop,def,"width"),visible:this._defordef(prop,def,"visible")}),pth.gca_id=id,pth.gca_group="PATHS",pth}_makeMarker(key,pos,id,grp,prop){const def={color:16777215,opacity:1,marker_size:24,visible:!0};let mrk=fabric.util.object.clone(this._icons[key].prg),hgt=this._defordef(this._config.display_props,def,"marker_size");mrk.scaleToHeight(hgt),mrk.gca_id=id,mrk.gca_group=grp,mrk.gca_position=new fabric.Point(pos.x,pos.y);let r=mrk.getBoundingRect();return mrk.left=pos.x-r.width/2,mrk.top=pos.y-hgt,mrk.set({stroke:this._parseColor(this._defordef(prop,def,"color")),fill:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),visible:this._defordef(prop,def,"visible"),selectable:!1}),mrk}_makeLabel(pos,txt,id,grp,prop){const def={color:16777215,font_size:14,opacity:1,visible:!0};let lbl=new fabric.Text(""+txt,{stroke:this._parseColor(this._defordef(prop,def,"color")),fill:this._parseColor(this._defordef(prop,def,"color")),opacity:this._defordef(prop,def,"opacity"),visible:this._defordef(prop,def,"visible"),fontSize:this._defordef(prop,def,"font_size"),fontWeight:"bold",selectable:!1});return lbl.left=pos.x,lbl.top=pos.y,lbl.gca_id=id,lbl.gca_group=grp,lbl}_pathIdxFromID(id){let pi=void 0,paths=this._config.paths;for(let i=0;i<paths.length;++i){if(paths[i].id==id){pi=i;break}}return pi}_getObjValue(map,x,y){var vidx,inside=!1,v=void 0,obj=map.object,dom=obj.domain,val=obj.values;if(x=Math.trunc(x)-dom.kol1,(y=Math.trunc(y)-dom.line1)>=0&&y<=dom.lastln-dom.line1&&x>=0&&x<=dom.lastkl-dom.kol1){var ivln=dom.intvlines[y];vidx=val.value_line_indices[y];for(let i=0;!inside&&i<ivln.length;++i){let iv=ivln[i];if(x>=iv[0]&&x<=iv[1]){vidx+=x-iv[0],inside=!0;break}vidx+=iv[1]-iv[0]+1}}return inside&&(v=val.values[vidx]),v}mapPointToMidline(p){let pom=void 0,pp=void 0,cp=this._config.paths[this._curPath],idx=this._getObjValue(cp.mapping,p.x,p.y);return void 0!==idx&&(pp=cp.points[idx]),void 0!==pp&&(pom={x:pp.x,y:pp.y,i:idx}),pom}addMarker(id,pos,txt,props){let spos=new fabric.Point(pos.x,pos.y),mpos=this.mapPointToMidline(spos);if(this._isDefined(mpos)){let mrk=this._makeMarker("pin",mpos,id,"MARKERS",props);if(this._markers_grp.add(mrk),this._canvas.moveTo(mrk,this._layers.MARKERS),this._isDefined(txt)){let lbl=this._makeLabel(mpos,txt,id,"MARKER_LABELS",props);this._markers_grp.add(lbl),this._canvas.moveTo(lbl,this._layers.MARKERS)}}}removeMarker(id){let mrk=this.findDispObj("MARKERS",id),lbl=this.findDispObj("MARKER_LABELS",id);this._isDefined(mrk[0])&&this._isDefined(mrk[1])&&(this._canvas.remove(mrk[1]),this._markers_grp.remove(mrk[1])),this._isDefined(lbl[0])&&this._isDefined(lbl[1])&&(this._canvas.remove(lbl[1]),this._markers_grp.remove(lbl[1]))}landmarkFromID(id){var lmk=void 0;let lmks=this._config.landmarks;for(let li=0;li<lmks.length;++li){let l=lmks[li];if(l.id===id){lmk=l;break}}return lmk}positionToPath(pos,tol){let fnd=[0,0,Number.MAX_VALUE],pv=new fabric.Point(pos.x,pos.y);for(let pi=0;pi<this._config.paths.length;++pi){let path=this._config.paths[pi];for(let pj=0;pj<path.n;++pj){let pp=path.points[pj],pq=new fabric.Point(pp.x-pv.x,pp.y-pv.y),d2=pq.x*pq.x+pq.y*pq.y;d2<fnd[2]&&(fnd[0]=pi,fnd[1]=pj,fnd[2]=d2)}}return fnd[2]<tol?fnd[2]=Math.sqrt(fnd[2]):fnd=void 0,fnd}_onMouseDown(e){this._pointer.button=e.button,this._pointer.drag=!1,this._pointer.position=new fabric.Point(e.pointer.x,e.pointer.y)}_onMouseMove(e){if(1==this._pointer.button){let del=new fabric.Point(e.pointer.x-this._pointer.position.x,e.pointer.y-this._pointer.position.y),del2=del.x*del.x+del.y*del.y;del2>this._pointer.drag_threshold_start?this._pointer.drag=!0:del2<this._pointer.drag_threshold_end&&(this._pointer.drag=!1),this._pointer.drag&&this._canvas.relativePan(del),this._pointer.position=new fabric.Point(e.pointer.x,e.pointer.y)}}_onMouseUp(e){if(1==this._pointer.button&&!this._pointer.drag){let pos=new fabric.Point(e.pointer.x,e.pointer.y),inv=fabric.util.invertTransform(this._canvas.viewportTransform);pos=fabric.util.transformPoint(pos,inv),this._isDefined(this._pick_fn)&&this._pick_fn(this,pos)}this._pointer.drag=!1,this._pointer.button=0}_onMouseWheel(opt){let e=opt.e;this._updateZoom(new fabric.Point(e.offsetX,e.offsetY),e.deltaY),e.preventDefault()}_onResize(){this._isDefined(this._container)&&this._isDefined(this._canvas)&&(this._canvas.setHeight(this._container.clientHeight),this._canvas.setWidth(this._container.clientWidth),this._setZoom())}_setZoom(){if(this._isDefined(this._canvas)&&this._isDefined(this._ref_image)){let sx=this._canvas.width/this._ref_image.width,sy=this._canvas.height/this._ref_image.height,s=sx<sy?sx:sy;s>1&&(s=1);this._canvas.width,this._canvas.height;this._canvas.zoomToPoint(new fabric.Point(0,0),s),this._debug&&console.log("DEBUG viewportTransform "+this._canvas.viewportTransform[0]+" "+this._canvas.viewportTransform[1]+" "+this._canvas.viewportTransform[2]+" "+this._canvas.viewportTransform[3]+" "+this._canvas.viewportTransform[4]+" "+this._canvas.viewportTransform[5])}}_updateZoom(pos,del){let z=this._canvas.getZoom()*Math.pow(.95,Math.sign(del));this._canvas.zoomToPoint(pos,z)}_loadJson(url,on_load){this._preLoad();let req=new XMLHttpRequest;req.open("GET",url,!1),req.overrideMimeType("text/html");req.onreadystatechange=function(){if(200===req.status){let obj=JSON.parse(req.responseText);on_load(obj),this._postLoad()}else alert("Failed to load JSON file "+url+".")}.bind(this),req.send()}_loadImage(url,on_load){this._preLoad(),fabric.Image.fromURL(url,(img,err)=>{err?alert("Failed to load image file "+url+"."):(on_load(img),this._postLoad())})}_loadSvg(url,on_load){this._preLoad(),fabric.loadSVGFromURL(url,obj=>{on_load(fabric.util.groupSVGElements(obj)),this._postLoad()})}_startLoad(){this._file_load_cnt=1}_preLoad(){++this._file_load_cnt}_postLoad(){--this._file_load_cnt,this._file_load_cnt<=0&&(this._createVisualisation(),this._isDefined(this._post_load_fn)&&this._post_load_fn())}_endLoad(){this._postLoad()}_isDefined(x){return void 0!==x}_isObject(x){return"object"==typeof x}_isArray(obj){return"[object Array]"===Object.prototype.toString.call(obj)}_isString(obj){return"[object String]"===Object.prototype.toString.call(obj)}_defordef(g,d,key){let v=void 0;return this._isDefined(g)&&key in g&&this._isDefined(g[key])?v=g[key]:this._isDefined(d)&&key in d&&(v=d[key]),v}_clamp(v,mn,mx){return v<mn?mn:v>mx?mx:v}_parseColor(gc){let nc=gc;return this._isString(gc)&&(nc=gc.replace("0x","#")),nc}}export{GCA2DRenderer};
